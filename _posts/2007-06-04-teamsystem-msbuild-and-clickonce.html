---
layout: post
title: TeamSystem, MSBuild and ClickOnce
date: '2007-06-04T08:02:00.000+02:00'
author: Marcus Hammarberg
tags:
- TFS
- MSBuild
modified_time: '2011-10-03T12:32:50.080+02:00'
blogger_id: tag:blogger.com,1999:blog-36533086.post-2160098077060148442
blogger_orig_url: http://www.marcusoft.net/2007/06/teamsystem-msbuild-and-clickonce.html
---

I've finally got around to work a bit more with our buildscript, which we are running on top of Team System. I've once coded a build script based on other products (CruiseControl.net, NUnit etc.) so i hoped and thought that this wouldn't differ to much. However sometimes your hopes gets fulfilled and sometimes... well, you'll see.<br /><br />Firstly building buildscripts for Team Systems are more like responding to events that gets fired by the Team System build engine, than writing the flow yourself. Which events get fired and which order they fire in can be found <a href="http://marcushammarberg.blogspot.com/2007/05/teamsystem-builds.html">here</a>.<br /><br />Also - the start of building buildscripts with Team System is a wizard, which is nice but all that it's really doing is generating the stub for the MSBuild-script-file for you. If you want to tweak it (and you want) you'll have to code in the "scary" MSBuild/XML-langauge.<br /><br />And finally the Team System doesn't come with loads of new functionality for MSBuild. So i still cast my vote on the MSBuild Community Task for anything slightly out of the box. They can be found and downloaded <a href="http://msbuildtasks.tigris.org/">here</a>.<br />I also got confirmed from Microsoft that ClickOnce-handling and versioning is not supported with the tasks included in Team System. Microsoft recommended me to use the MSBuild Community Tasks.<br /><hr /><br />So - now to my buildscript. What we wanted to do was fairly simple (we thought); we just wanted to build the application and then perform a ClickOnce-publish to a certain location, in such a way that the latest version of the application automatically would be downloaded for any user accessing it.<br /><br />This is how i did it:<br /><br />First i created an itemgroup (called ClickOnceProjects) with parameters for the ClickOnce-deployment. This item group could be repeted for all projects that is to be published with ClickOnce. <small><code><br />&lt;ItemGroup&gt;<br />&lt;ClickOnceProjects Include="$(SolutionRoot)\$(ProjectNamespace).UI.Win\$(ProjectNamespace).UI.Win.vbproj"&gt;<br />&lt;ProjectPublishProperties&gt;InstallUrl=\\[servername]\Install\&lt;/ProjectPublishProperties&gt;<br />&lt;PublishDirectoryName&gt;$(ProjectNamespace).UI.Win.publish&lt;/PublishDirectoryName&gt;<br />&lt;DeploymentFolderClient&gt;$(ClickOnceDropLocation)&lt;/DeploymentFolderClient&gt;<br />&lt;ExecutableName&gt;App.exe&lt;/ExecutableName&gt;<br />&lt;DeploymentThumbPrint&gt;$(SolutionRoot)\$(ProjectNamespace).UI.Win\$(ProjectNamespace).UI.Win_TemporaryKey.pfx&lt;/DeploymentThumbPrint&gt; &lt;DeploymentPublishProperties&gt; Configuration=Release;ProductName=App;PublisherName=Us; GenerateManifests=true;WebPage=default.htm&lt;/DeploymentPublishProperties&gt;<br />&lt;/ClickOnceProjects&gt;<br />&lt;/ItemGroup&gt;<br /></code></small><br />On the <strong>AfterGet</strong>-target (which gets called by the TeamSystem-build-engine when the sourcefiles are retrieved from SourceControl) i do the following:<br /><br /><ol><li>Check out Version.txt which is a file with the versionnumber</li><li>Check out Soulution.vb. This is a AssemblyInfo-file that is shared (linked-in) in all the projects of our solution. In this way we can get the same versionnumber for all our assemblies.</li><li>Update the Versionnumber by incrementing the revsionnumber with one. For this we used the &lt;Version&gt;-task from MSBuild Community Task like:<br /><small><code><br />&lt;Version VersionFile="$(SolutionRoot)\SolutionItems\Version.txt" RevisionType="Increment"&gt;<br />&lt;Output TaskParameter="Major" PropertyName="Major" /&gt;<br />&lt;Output TaskParameter="Minor" PropertyName="Minor" /&gt;<br />&lt;Output TaskParameter="Build" PropertyName="Build" /&gt;<br />&lt;Output TaskParameter="Revision" PropertyName="Revision" /&gt;<br />&lt;/Version&gt;<br />&lt;Message Text="New version: $(Major).$(Minor).$(Build).$(Revision)"/&gt;</code></small></li><li>Then the SolutionInfo.vb gets deleted and recreated with the new verion number by using the AssemblyInfo-task like:<br /><small><code><br />&lt;Delete<br />Condition="Exists('$(SolutionRoot)\SolutionItems\SolutionInfo.vb')"<br />Files="$(SolutionRoot)\SolutionItems\SolutionInfo.vb" /&gt;<br /><br />&lt;!-- Recreate SolutionInfo.vb --&gt;<br />&lt;Message Text="SYSTEM_NAME: Recreating Solution.vb"/&gt;<br />&lt;AssemblyInfo CodeLanguage="VB"<br />OutputFile="$(SolutionRoot)\SolutionItems\SolutionInfo.vb"<br />ComVisible="false"<br />CLSCompliant="false"<br />AssemblyConfiguration="Release"<br />AssemblyCompany="CompanyName"<br />AssemblyProduct="SystemName"<br />AssemblyCopyright="Copyright Â© Company 2007"<br />AssemblyVersion="$(Major).$(Minor).$(Build).$(Revision)"/&gt;</code></small></li></ol><br />Now the Team System build engine will go about and do it's stuff compiling etc. But then on the <strong>AfterDropBuild-</strong>target (when the executables is dropped to the build location) i publish the ClickOnce-applications (specified in the itemgroup above) as follows:<br /><br /><ol><li>Clean the content of the publish-location so that only the latest version of the build is available:<br /><small><code><br />&lt;RemoveDir Directories="$(ClickOnceDropLocation)" /&gt;<br />&lt;MakeDir Directories="$(ClickOnceDropLocation)" /&gt;</code></small></li><li>Then do a MSBuild-publish. This creates variables/output that contains the files for the ClickOnce-deployment. All important for this task to execute sucessfully is that you controll the versionnumber (which we do as shown above).<br />The task is executed as follows:<br /><small><code><br />&lt;MSBuild Targets="Publish" Projects="@(ClickOnceProjects)"<br />Properties="%(ClickOnceProjects.ProjectPublishProperties);%(ClickOnceProjects.DeploymentPublishProperties); PublishUrl=%(ClickOnceProjects.DeploymentFolderClient); MinimumRequiredVersion=$(Major).$(Minor).$(Build).$(Revision); ApplicationVersion=$(Major).$(Minor).$(Build).$(Revision)"&gt;<br />&lt;Output TaskParameter="TargetOutputs" ItemName="PublishTargetOutputs"/&gt;<br />&lt;/MSBuild&gt;</code></small></li><li>The output of this target is then moved to the publish-location like so:<br /><small><code><br />&lt;CreateItem Include="@(ClickOnceProjects-&gt;'%(RelativeDir)bin\Release\SystemName.publish\**\*.*')"&gt;<br />&lt;Output TaskParameter="Include" ItemName="FilesToPublish"/&gt;<br />&lt;/CreateItem&gt;<br /><br />&lt;!--Copy the publication-files to the server--&gt;<br />&lt;Copy SourceFiles="@(FilesToPublish)"<br />DestinationFiles="@(FilesToPublish-&gt;'%(DeploymentFolderClient)\%(RecursiveDir)%(Filename)%(Extension)')"<br />SkipUnchangedFiles="false" /&gt;</code></small></li></ol><br />Then of course we check-in the Version.txt and the SolutionInfo.vb on a successful build (as the last part of the <strong>AfterDropBuild</strong>-target) and do undo check-out on it on a failure (the<br /><strong>BeforeOnBuildBreak-</strong>target)<br /><br />This is how we got the Gods of ClickOnce, MSBuild and Team System to work together in wonderful harmony. I am sure that this is only one of many ways you can do this, but this is one way and it works.<br /><br />I realize that this can be hard to read and understand so please don't hesitate to contact me for the build-script-file or more information.