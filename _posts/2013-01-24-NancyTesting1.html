---
layout: post
title: Nancy.Testing - a closer look through her testability
date: '2013-01-24T09:00:00.000+01:00'
author: Marcus Hammarberg
tags:
- Nancy
- Tools
- .NET
- Test
- Agile
modified_time: '2014-06-21T02:09:55.461+02:00'
blogger_id: tag:blogger.com,1999:blog-36533086.post-2536136940455319768
blogger_orig_url: http://www.marcusoft.net/2013/01/NancyTesting1.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div class="separator" style="clear: both; text-align: center;"><a href="http://nancyfx.org/images/logo.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="200" src="http://nancyfx.org/images/logo.png" width="178" /></a></div>For quite some time I've been a fan and proponent of a .net web framework called <a href="http://www.nancyfx.org/" target="_blank">Nancy</a>. She describe herself like a: "a lightweight, low-ceremony, framework for building HTTP based services on .Net and Mono" and she looks like the picture on the side.<br /><br />There's much to admire about Nancy (a working web app in a tweet is really cool) and the code and features are pure quality from start to finish, much to the work that <a href="http://thecodejunkie/" target="_blank">@theCodeJunkie</a>&nbsp;(Andreas HÃ¥kansson) and <a href="https://twitter.com/Grumpydev" target="_blank">@grumpydev</a> (Steven Robbins)&nbsp;is putting in, with the help of a growing and engaged community.<br /><br />The thing that really blowed me away when I first saw it was the testing abilities of Nancy. She's built for testing from the word Go and that gives us some nice features to play with.<br /><br />I thought I devote a couple of posts to the testing abilities of Nancy, here's what I have planned:<br /><ol style="text-align: left;"><li><a href="http://www.marcusoft.net/2013/01/NancyTesting1.html" target="_blank">Intro to testing with Nancy</a>(this post)</li><li><a href="http://www.marcusoft.net/2013/01/NancyTesting2.html" target="_blank">The Configurable bootstrapper</a></li><li><a href="http://www.marcusoft.net/2013/01/NancyTesting3.html" target="_blank">The Browser and Response objects</a>&nbsp;</li><li><a href="http://www.marcusoft.net/2013/02/NancyTesting4.html" target="_blank">Hat and shoeless testing with Simple.Data</a></li><li><a href="http://www.marcusoft.net/2013/02/NancyTesting5.html" target="_blank">SpecFlow and Nancy</a></li></ol><div>The underlying idea here is to get to know Nancy better, through tests. Join me if you want. The speed of the blog posts will be much dependent on how the book writing goes (Kanban In Action...). At the time of writing I have the first two posts prepared, and the rest in my head.&nbsp;</div><div><a name='more'></a><h3 style="text-align: left;">Why is Nancy easy.. to test</h3></div><div>Nancy is a web framework built from the ground up. Which means that it has no&nbsp;dependencies&nbsp;to System.Web or any of the web-stuff in .NET framework. Those parts have been notoriously hard to test (<a href="http://en.wikipedia.org/wiki/Mock_object" target="_blank">mocking</a> the complete Request-object is a nightmare that still haunts many of us).&nbsp;</div><div><br /></div><div>Not only that - the creators of Nancy have themselves worked with testing as a main feature of the framework, probably even test-first. This has led the framework to be very testable from the outset. To connect back on my <a href="http://www.marcusoft.net/2013/01/on-constraints.html" target="_blank">post on constraints</a>: they constrained themselves to test everything, which made them create a very testable framework. Thank you constraint!</div><div><br /></div><div>There are two levels where this testability thoughts shine through to great effect;&nbsp;</div><div><ul style="text-align: left;"><li>Everything can be replaced! Nancy is built to replace every part of her - even core properties such as the NancyEngine&nbsp;itself&nbsp;(you can imagine what that does...). This is a dream for someone who needs to mock stuff out.</li><li>The <a href="http://nancy.testing/">Nancy.Testing</a> framework helps you to test the complete stack of an Nancy-application, without touching slow and expensive resources such as the network.&nbsp;</li></ul><div>That last part requires an explaination I think. When you create a Nancy.Testing.Browser you need to pass in a Nancy.Bootstrapper.INancyBootstrapper. That might be seen as cumbersome but it gives you some great advantages and is not really hard as this example will show you:</div></div><script src="https://gist.github.com/4563590.js"></script> <br /><div><br /></div><div>Moreover - this will actually test <b>everything</b>, the complete Nancy-stack. Without hitting the network. Yes - I know. I didn't get that first either. But let's look what&nbsp;possibilities&nbsp;that gives us first and I'll try to explain it better afterwards:<br /><div><script src="https://gist.github.com/4563651.js"></script></div><br /><div>As you can see from that example we can supply a fully populated Request-object, with all the context we need for our Request (headers, options, body you name it).<br />Executing that request (with the Get-method in this case to perform a HTTP-GET returns a Response-object. That response contains the generated view from the Nancy-module, meaning that it's been through the complete Nancy-stack, except that it haven't gone through the network, hit any web servers etc. And still you can access and search the generated view with <a href="http://www.w3.org/TR/CSS2/selector.html" target="_blank">CSS Selectors</a> as you would normally do in a web automation tool. It's web automation with the web part ripped out - some people call this a <a href="http://blog.arhg.net/2009/10/what-is-headless-browser.html" target="_blank">headless browser.</a><br /><h4 style="text-align: left;">Contrasting with ASP.NET MVC options</h4></div><div>If you were to test the same thing with an ASP.NET MVC application you are faced with two options:&nbsp;</div><div><ul style="text-align: left;"><li>test the controller directly. This is nice since the controller is just a class. You can supply dependencies and control the way it's called to test what you want. But you get back a View-object. The&nbsp;templated&nbsp;view is not executed, so you don't know how the page is generated.&nbsp;</li><li>Which brings us to option number 2: test against the view. To do this you will have to fire up a <a href="http://www.marcusoft.net/2012/05/specflow-page-objects-and.html" target="_blank">browser automation tool</a>&nbsp;that first need to start. Then the application is "deployed" in your local IIS or Casini web server. When that is booted up the first call to your application is made, routed, the view generated and the HTML returned.<br />In short - this takes a lot of time, and slows down both testing and the feedback loop.&nbsp;</li></ul><h3 style="text-align: left;">Summing up Nancy testability</h3></div><div><a href="http://nancy.testing/">Nancy.Testing</a> gives you a great way to test your complete stack, with full control of it's execution. This in turn gives you the&nbsp;opportunity&nbsp;to write small specific test, without a lot of setup to get to the right page on the site etc, and a really fast feedback-loop.</div><div><h3 style="text-align: left;">The basic setup</h3></div><div>Here follows the steps I went through to get started testing a new application.</div><div><ol style="text-align: left;"><li>Created a new Solution, <a href="https://github.com/marcusoftnet/DiscoveringNancyThroughTests" target="_blank">NancyTesting</a></li><li>Added class library for test,&nbsp;DiscoverNancy.Tests</li><li>Nugot Nancy.Testing (<a href="http://nuget.org/packages/Nancy.Testing" target="_blank">Install-Package Nancy.Testing</a>) into the test class library.</li><li>Installed my test framework of choice: xUnit (<a href="http://install-package%20xunit/" target="_blank">Install-Package xUnit</a>)</li><li>Wrote my first test<br /><div><script src="https://gist.github.com/4563752.js"></script></div></li><li>That failed of course since the application and route doesn't existed. But if failed with an error stating: <br /><pre>"Xunit.Sdk.EqualException: Assert.Equal() Failure<br />Expected: OK<br />Actual: &nbsp; NotFound"</pre></li><li>So, the route was not found. I need to create the NancyModule that holds it. That's the famous Fit-In-A-Tweet-Module:<br /><div><script src="https://gist.github.com/4563805.js"></script></div></li><li>With that in place my test passed.&nbsp;</li></ol>This was of course a very simplistic example, and I'll be showing you more advanced examples later. But it shows a lot of the testability of Nancy already. For example, I have yet to move the SimpleModule into a hosting environment and I can still test the whole stack...<br /><h3>The moving parts</h3>In this post we have touched on all the parts of the Nancy.Testing-framework, but very briefly. I thought I list the important classes and concepts here and give a high-level description of it:<br /><ul style="text-align: left;"><li>Nancy.Testing.Browser - this is the main object of the testing infrastructure in Nancy. The class that you use to call your application. It has methods for performing all HTTP Requests (GET, POST, PUT ... <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods" target="_blank">you know them</a>) and returns a response object.</li><li>The Request object is, as said above, our way to access the routes and functionality in the Nancy Module under test. With the Request object we can send in all the context (Forms, Querystring and headers) that's needed to test out our application.&nbsp;</li><li>The Response object gives us the ability to assert the content of our response, may it be simple status codes or complex views that's generated from our application.&nbsp;</li><li>Bootstrapper - the <a href="https://github.com/NancyFx/Nancy/wiki/Bootstrapper" target="_blank">Bootstrapper</a>&nbsp;is the thing that wires together a Nancy application. From a testing point of view there's great news here. The bootstrapper is needed to create a Browser object and through this we can control most of the environment, that the NancyModule we are testing, is executing under.&nbsp;</li></ul><h3 style="text-align: left;">Summary</h3>In this first post of this series we took a quick look at the marvelous testing capabilities of Nancy. We talked about why it's so easy to test and we briefly looked into the moving parts of Nancy testing.<br /><br />In subsequent post we will dive deeper into these concepts and see how we can bend them to our will, creating a excellent testing environment for our applications.&nbsp;</div></div></div>