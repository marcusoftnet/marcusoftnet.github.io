---
layout: post
title: 'Marcus Node Bits: mocha is cool both as framework and test runner'
date: '2014-02-06T14:00:00.000+01:00'
author: Marcus Hammarberg
tags:
- MobProgramming
- Javascript
- BDD
- Tools
modified_time: '2014-06-02T10:56:52.510+02:00'
thumbnail: http://1.bp.blogspot.com/-hRHgJNQBIiU/Uu4xLbhcCyI/AAAAAAAAB6I/HsWG3V-Asmk/s72-c/Screen+Shot+2014-02-02+at+18.40.48+.png
blogger_id: tag:blogger.com,1999:blog-36533086.post-4430213870078035524
blogger_orig_url: http://www.marcusoft.net/2014/02/mnb-mocha.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">I'm writing down some of the things I've picked up when I started to learn about&nbsp;<a href="http://nodejs.org/" target="_blank">Node</a>,&nbsp;<a href="http://expressjs.com/" target="_blank">Express</a>&nbsp;and&nbsp;<a href="http://www.mongodb.org/" target="_blank">Mongo</a>. Here are all the post in the series:<br /><ul><li><a href="http://www.marcusoft.net/2014/02/mnb-terminal.html" target="_blank">Doing stuff in the terminal is not scary at all</a></li><li><a href="http://www.marcusoft.net/2014/02/mnb-npm.html" target="_blank">npm is not only for getting packages</a></li><li><a href="http://www.marcusoft.net/2014/02/mnb-packagejson.html" target="_blank">Package.json is a mighty tool</a></li><li><a href="http://www.marcusoft.net/2014/02/mnb-git.html" target="_blank">Git is not that hard, but I need to refresh my knowledge</a></li><li><a href="http://www.marcusoft.net/2014/02/mnb-callbacks.html" target="_blank">Callback function is cool stuff, and I even know how to write them</a></li><li>mocha is cool both as framework and test runner &nbsp;- this post</li><li><a href="http://www.marcusoft.net/2014/02/mnb-should.html" target="_blank">Should is a nice way to do asserts</a>&nbsp;</li><li><a href="http://www.marcusoft.net/2014/02/mnb-monk.html" target="_blank">monk is an easy way to access mongo</a></li><li><a href="http://www.marcusoft.net/2014/02/mnb-express.html" target="_blank">Express is best without generators</a></li><li><a href="http://www.marcusoft.net/2014/02/mnb-supertest.html" target="_blank">supertest is a nice way to test an api</a></li></ul>When it comes to testing frameworks on the javascript and node stack it's an abundance of choices, just like for any of your needs. Once again you need to look around, ask around and make up your mind by yourself.<br /><br /><a name='more'></a>The two frameworks that are mentioned the most is <a href="http://pivotal.github.io/jasmine/" target="_blank">jasmine</a>&nbsp;and <a href="http://visionmedia.github.io/mocha/" target="_blank">mocha</a>. The way you write your tests in these frameworks are very much alike and the main difference is in how you run them. Jasmine is executed in a browser (as I understand it) and mocha is run at the terminal, but could be run in the browser too. I like <a href="http://www.marcusoft.net/2014/02/mnb-terminal.html">the terminal</a>, as you know.<br /><br />Ok, there’s also test runners that isn’t a test framework… like <a href="http://karma-runner.github.io/" target="_blank">Karma</a>, and probably some more. These tools run any kind of tests (like jasmine, mocha or what have you). &nbsp;At first I tried to use this but when I realised that mocha comes with a test runner that suited all my needs up to now. And it was a much easier set up.<br /><br />I’ve got stuck on mocha since I think the runner is very capable and the syntax is nice. Finally it was really easy to get started with, where there are few more pieces to puzzle together with Jasmine.<br />Mocha is installed with ease, just like any node package, by<br /><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;">npm install mocha</span>.&nbsp;</blockquote>If you add the “<span style="font-family: Courier New, Courier, monospace;">-g</span>” flag you’ll be able to run mocha tests in any directory. Remember, from my <a href="http://www.marcusoft.net/2014/02/mnb-mocha.html">package.json-post</a>, that you should include it in your local node_modules as well. In my opinion, once you have pulled down a project you should just have to go “<span style="font-family: Courier New, Courier, monospace;">npm install</span>” and then be able to run it. No extra steps should be required. <span class="Apple-tab-span" style="white-space: pre;"> </span><br /><h3 style="text-align: left;">The syntax</h3>The syntax of a mocha (and to be honest most JavasScript testing frameworks I’ve seen) resembles the Ruby tool <a href="http://rspec.info/">RSpec</a>. It’s a pretty straight forward API and for most of your needs you only need to care about 3 to 4 functions:<br /><div style="text-align: left;"></div><ul style="text-align: left;"><li><span style="font-family: Courier New, Courier, monospace;">describe(description, func)</span> – this is the top level function of your tests. It takes a string description of the thing that you are describing (or testing if you have your tester hat on) and then a function with it-statements. This would be the test fixture in xUnit frameworks.&nbsp;</li><ul><li>These can be nested and we’ll get back to how to &nbsp;write this without going crazy.&nbsp;</li></ul><li><span style="font-family: Courier New, Courier, monospace;">it(description, func)</span>&nbsp;– this is your actual specifications that poke your system and does tests. The test-methods if you want to compare it with xUnit style of tests.&nbsp;</li><li><span style="font-family: Courier New, Courier, monospace;">beforeeach(func)</span><span style="font-family: inherit;">and</span><span style="font-family: Courier New, Courier, monospace;"> before(func)</span>&nbsp;– this is methods that is executed before... Before what you might ask, well that has to do with where you place them. If you place them inside a <span style="font-family: Courier New, Courier, monospace;">describe</span><span style="font-family: inherit;">-block (which is the most common place I use them) then the </span><span style="font-family: Courier New, Courier, monospace;">beforeEach</span><span style="font-family: inherit;">-block is run before</span>&nbsp;each it-statement. It can also be place outside any <span style="font-family: Courier New, Courier, monospace;">describe</span>&nbsp;and will then be run for all the <span style="font-family: Courier New, Courier, monospace;">describe</span>'s. &nbsp;It suitable for setup of your system under test, for example</li><li><span style="font-family: Courier New, Courier, monospace;">aftereach(func)</span><span style="font-family: inherit;"> and </span><span style="font-family: Courier New, Courier, monospace;">after(func)</span>&nbsp;– and there´s a tear down version of course. The same rules goes for that.&nbsp;</li></ul>Mocha is much bigger than this, but with these simple api I've managed most my testing needs so far.<br /><h3 style="text-align: left;">The done() parameter</h3><div>One thing that really messed things up for me in the beginning was when I left out or didn't handle the <span style="font-family: Courier New, Courier, monospace;">done</span>-parameter to my <span style="font-family: Courier New, Courier, monospace;">it</span><span style="font-family: inherit;">-statements. I think (and will hopefully be corrected on this if I'm wrong) that mocha runs it's test asynchronously, as many things are with <a href="http://nodejs.org/">Node</a>. This means that we need to inform mocha on when our test code is </span><span style="font-family: Courier New, Courier, monospace;">done</span><span style="font-family: inherit;">, so that mocha can pick it up again and process the next test. &nbsp;</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">This sounds complicated but in reality just comes as a parameter to the functions in our </span><span style="font-family: Courier New, Courier, monospace;">describe, before/after </span><span style="font-family: inherit;">and</span><span style="font-family: Courier New, Courier, monospace;"> it</span><span style="font-family: inherit;">-statements. That parameter, </span><span style="font-family: Courier New, Courier, monospace;">done</span><span style="font-family: inherit;">, is a function that we call when our test is complete. Like this:</span></div><script src="https://gist.github.com/marcusoftnet/8767179.js"></script> <br /><div><span style="font-family: inherit;">Failing to call the done-function will render a timeout exception and you'll faced with an error message like this:</span><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-hRHgJNQBIiU/Uu4xLbhcCyI/AAAAAAAAB6I/HsWG3V-Asmk/s1600/Screen+Shot+2014-02-02+at+18.40.48+.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-hRHgJNQBIiU/Uu4xLbhcCyI/AAAAAAAAB6I/HsWG3V-Asmk/s1600/Screen+Shot+2014-02-02+at+18.40.48+.png" height="98" width="640" /></a></div><span style="font-family: inherit;"><br /></span></div><div style="text-align: left;">Confused the crap out of me at first. Call <span style="font-family: Courier New, Courier, monospace;">done()</span> in the end of your <span style="font-family: Courier New, Courier, monospace;">it</span>-statements and it goes aways.&nbsp;</div><h3 style="text-align: left;">How I write the tests and keep sane counting parentheses</h3>This is just following the way of writing that I sketched out in <a href="http://www.marcusoft.net/2014/02/mnb-callback.html">this post</a>&nbsp;but it was when writing mocha-tests that I first found the great use of writing my code in this manner. Because, like I said, the describe-functions are just that; functions. But when a complete test case is written out they look like something completely different. It's not uncommon that they end in <span style="font-family: Courier New, Courier, monospace;">});});});});</span>&nbsp;and everyone is just fine with it.<br /><br />Let’s take an example ; let’s pretend we’re writing the specifications for how users behave in our system. This includes the validation and storage (and probably some more). I would write this like this, in sequences:<br /><script src="https://gist.github.com/marcusoftnet/8767394.js"></script> Already at this point you could run the tests. It wouldn’t say much as result, since there are no real tests in there, but it’s a good check to see that you haven’t mess things up.<br />I often fill out empty it-functions for some for the features as well. This doesn’t against the TDD rhythm of having just one failing test, since writing the it’s like this will just render them “inconclusive”. I think it’s a nice way of structuring you’re work and get an overview.<br />Under each describe I would write stubs for the it-statements, like this:<br /><script src="https://gist.github.com/marcusoftnet/8767540.js"></script> Running the test (with <span style="font-family: Courier New, Courier, monospace;">mocha -u bdd -R spec</span><span style="font-family: inherit;"> see below)</span>&nbsp;like they are written above produce this nice little output in our console:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-0FaImdy__1c/Uu43EdhHwwI/AAAAAAAAB6g/YqLa0Y5WUIQ/s1600/Screen+Shot+2014-02-02+at+19.14.54+.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-0FaImdy__1c/Uu43EdhHwwI/AAAAAAAAB6g/YqLa0Y5WUIQ/s1600/Screen+Shot+2014-02-02+at+19.14.54+.png" height="292" width="400" /></a></div><br />And you’re now ready to start work with your first test.<br /><h3 style="text-align: left;">Mocha test runner and reporters</h3>The mocha test runner is a command line tool that you run from your command prompt. The <a href="http://www.visualstudio.com/">Visual Studio</a> guy in me is complaining at this fact, but the newly born <a href="http://www.marcusoft.net/2014/02/mnb-terminal.html">terminal</a> guy is ok with it and holds the Visual Studio guys hand (yeah, there’s quite a few of me in there… should probably do something about that some day).<br /><br />Ok, the test runner. At it’s core is very simple; go <span style="font-family: Courier New, Courier, monospace;">mocha</span>&nbsp;and it will run all tests (as in “all the .js-files with describe-functions in them) &nbsp;in the <span style="font-family: Courier New, Courier, monospace;">test</span> directory. But there’s a <a href="http://visionmedia.github.io/mocha/#usage">lot of switches</a> and here are the ones that I often use:<br /><ul style="text-align: left;"><li><span style="font-family: Courier New, Courier, monospace;">-u bdd</span> – with this switch you can set the style of writing. BDD-style means that you write <span style="font-family: Courier New, Courier, monospace;">describe</span> and <span style="font-family: Courier New, Courier, monospace;">it </span><span style="font-family: inherit;">in your tests, i.e. what&nbsp;</span>I’ve described above. There’s also “tdd” and “exports” but I don't use that.&nbsp;</li><li><span style="font-family: Courier New, Courier, monospace;">-R spec</span> – this is how you want the result of your test execution to be presented, i.e. the reporter. I like the specification style since it reads nice, especially if you pay attention to how you formulate and nest &nbsp;your specifications. There are loads of other reporters (10+ on my machine). Noteworthy are:</li><ul><li><span style="font-family: Courier New, Courier, monospace;">dot</span> - .F.. you get it, huh?&nbsp;</li><li><span style="font-family: Courier New, Courier, monospace;">list</span> - writes sentences from your specs</li><li><span style="font-family: Courier New, Courier, monospace;">markdown</span> - that produces markdown pages&nbsp;</li><li><span style="font-family: Courier New, Courier, monospace;">min</span> - a minimal reporter that just gives you number of passed/failed/inconclusive&nbsp;</li></ul><li><span style="font-family: Courier New, Courier, monospace;">-w</span> - this handy little flag starts watching your directory for changes. That is; it keeps executing the test for each change. I often issue this command in a separate terminal and keep them running as I go. I have had some problems getting this command to pick up new files, but a quick stop-and-go resolves that. And you stop with CTRL+C if you didn´t know that.</li></ul>As I said, there <a href="http://visionmedia.github.io/mocha/#usage" target="_blank">are loads of more switches</a> but these are the ones that I’ve used the most.<br />One last thing about switches: if you end up having a lot of them you can save them in a separate file called <span style="font-family: Courier New, Courier, monospace;">mocha.opts</span> or as a script in your <a href="http://www.marcusoft.net/2014/02/mnb-packagejson.html">package.json</a>&nbsp;like I described before. &nbsp;Put the mocha.opts file in your test directory and just enter each switch on a separate line in the file, it’s just a simple text file.<br />I've come to favour adding a node under scripts in the&nbsp;<a href="http://www.marcusoft.net/2014/02/mnb-packagejson.html">package.json</a>&nbsp;file and just add the switches there. I often do&nbsp;two scripts <span style="font-family: Courier New, Courier, monospace;">npm test&nbsp;</span>and <span style="font-family: Courier New, Courier, monospace;">npm watch_test</span>. One with the <span style="font-family: Courier New, Courier, monospace;">-w</span>-flag and one without.<br /><br />I wanted to talk about <a href="http://www.marcusoft.net/2014/02/mnb-should.html">should</a> here too but this post is a bit long already. <a href="http://www.marcusoft.net/2014/02/mnb-should.html">Until next time.</a>&nbsp;</div>