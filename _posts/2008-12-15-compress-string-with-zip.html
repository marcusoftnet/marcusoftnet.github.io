---
layout: post
title: Compress a string with zip
date: '2008-12-15T15:52:00.002+01:00'
author: Marcus Hammarberg
tags:
- .NET
- Life of a consultant
- C#
modified_time: '2009-01-12T07:57:42.696+01:00'
blogger_id: tag:blogger.com,1999:blog-36533086.post-8330905761469245113
blogger_orig_url: http://www.marcusoft.net/2008/12/compress-string-with-zip.html
---

<p><strong>[UPDATE START]</strong></p><p>We found a nasty performance bug in the code below. The DeCompress-method copies a string for each turn in the loop. That is a classic problem that creates a new copy of the string for each row. That became a major problem for a 3.8 Mb string...</p><p>I have now updated the code to use the System.Text.StringBuilder object instead. That took down the speed to about a tenth. Sorry that I didn't catch that...</p><p><strong>[UPDATED STOP]</strong></p><p>We had a quite special need the other day; we wanted to compress a part of our request, namely a XML-string that was sent to us. </p><p>Most of the examples I found on the net showed how to compress the content of a file. But here is the code that compress a string. The code uses <a href="http://www.icsharpcode.net/OpenSource/SharpZipLib/" target="_blank">ICSharpCode.SharpZipLib</a>. Here you go:</p><blockquote><p>/// &lt;summary&gt;<br />/// Compress strings with ICSharpCode.SharpZipLib<br />/// &lt;/summary&gt;<br />public class StringZipper<br />{<br />    public static string Compress(string uncompressedString)<br />    {<br />        byte[] bytData = System.Text.Encoding.UTF8.GetBytes(uncompressedString);<br />        MemoryStream ms = new MemoryStream();<br />        Stream s = new DeflaterOutputStream(ms);<br />        s.Write(bytData, 0, bytData.Length);<br />        s.Close();<br />        byte[] compressedData = (byte[])ms.ToArray();<br />        return System.Convert.ToBase64String(compressedData, 0, compressedData.Length);<br />    } </p><p> </p><p>    public static string DeCompress(string compressedString)<br />    {<br />        StringBuilder uncompressedString = new StringBuilder();<br />        int totalLength = 0;<br />        byte[] bytInput = System.Convert.FromBase64String(compressedString); ;<br />        byte[] writeData = new byte[4096];<br />        Stream s2 = new InflaterInputStream(new MemoryStream(bytInput));<br />        while (true)<br />        {<br />            int size = s2.Read(writeData, 0, writeData.Length);<br />            if (size &gt; 0)<br />            {<br />                totalLength += size;<br />                uncompressedString.Append(System.Text.Encoding.UTF8.GetString(writeData, 0, size));<br />            }<br />            else<br />            {<br />                break;<br />            }<br />        }<br />        s2.Close();<br />        return uncompressedString.ToString();<br />    }<br />}</p></blockquote><p>And here is how to call it:</p><blockquote><p>// Compress the string<br />                    string orgString = "Hello compression with åäö.";<br />                    //orgString = File.ReadAllText(args[0]); </p><p>                    Stopwatch sw = new Stopwatch();<br />                    sw.Start();<br />                    string compressedString = StringZipper.Compress(orgString);<br />                    sw.Stop();<br />                    string compressTime = sw.ElapsedMilliseconds.ToString(); </p><p>                    // Decompress the string<br />                    sw.Reset(); sw.Start();<br />                    string decompressedString = StringZipper.DeCompress(compressedString);<br />                    sw.Stop();<br />                    string decompressTime = sw.ElapsedMilliseconds.ToString(); </p><p>                    if (orgString == decompressedString)<br />                        Console.WriteLine("SAME");<br />                    else<br />                        Console.WriteLine("DIFFER"); </p><p>                    // Show some nice statistics<br />                    decimal ratio = (decimal)compressedString.Length / (decimal)orgString.Length;<br />                    Console.WriteLine(string.Format("Orignal string was: {0} chars", orgString.Length));<br />                    Console.WriteLine(string.Format("Compressed string was: {0} chars", compressedString.Length));<br />                    Console.WriteLine(string.Format("DeCompressed string was: {0} chars ", decompressedString.Length));<br />                    Console.WriteLine(string.Format("Compression ratio {0}", ratio));<br />                    Console.WriteLine(string.Format("The compression took {0} ms, DeCompression took {1} ms", compressTime, decompressTime));</p></blockquote><p>I should point out two things;</p><ul><li>For short strings the compressed string might actually be longer than the original. </li><li>It's not very good to store the result of the compression as a string (as done by System.Convert.ToBase64String), but it's quite nice to have for serialization. </li></ul>