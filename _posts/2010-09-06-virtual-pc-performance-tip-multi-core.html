---
layout: post
title: 'Virtual PC performance tip: Multi-core support'
date: '2010-09-06T11:17:00.001+02:00'
author: Marcus Hammarberg
tags:
- Tools
- Life of a consultant
modified_time: '2013-10-08T09:19:43.239+02:00'
thumbnail: http://lh3.ggpht.com/_TI0jeIedRFk/TISxkg8QexI/AAAAAAAAAlw/f0yoCKtF7YY/s72-c/taskmanagerwith2cores_thumb.jpg?imgmax=800
blogger_id: tag:blogger.com,1999:blog-36533086.post-8875288799659277872
blogger_orig_url: http://www.marcusoft.net/2010/09/virtual-pc-performance-tip-multi-core.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">I often get to work with brilliant people. That’s one the real benefits of being a consultant, I would argue. Last week I got to know Thomas Gyllencreutz that came onboard my project. He didn’t waste any time to get the performance in our virtual development environments to new heights. This post is a condensation of his findings that really got our Virtual PC images flying.&nbsp; <br />A general performance tip is to put your virtual hard drive (.vhd-file) on a separate hard drive, as <a href="http://www.hanselman.com/blog/VMPerformanceChecklistBeforeYouComplainThatYourVirtualMachineIsSlow.aspx" target="_blank">suggested by mr Hanselmann</a>.<br />OK, to get the multi-core support you’ll need to find out how many cores your system have. The easiest way to do that is to open Task Manager (CTRL+SHIFT+Esc) and check the number of CPU-boxes under the performance tab:<br /><a href="http://lh3.ggpht.com/_TI0jeIedRFk/TISxkNZ28wI/AAAAAAAAAls/6TLk7gxM058/s1600-h/taskmanagerwith2cores%5B2%5D.jpg"><img alt="taskmanagerwith2cores" border="0" height="244" src="http://lh3.ggpht.com/_TI0jeIedRFk/TISxkg8QexI/AAAAAAAAAlw/f0yoCKtF7YY/taskmanagerwith2cores_thumb.jpg?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; display: block; float: none; margin-left: auto; margin-right: auto;" title="taskmanagerwith2cores" width="218" /></a> <br />This guide expects you to have a existing .VHD-file. The one with the performance you want to boost ;). The guide also works from a Windows XP SP3 installation. You will need two files from it’s I386-folder (HALMACPI.DLL and NTKRNLMP.EXE).<br />Finally, if you haven’t already, enable hardware virtualization in your BIOS, if possible. That’s done different on different systems so I won’t describe it here. <br />To be able to use the settings we need (SMP) we’ll use the free <a href="http://www.virtualbox.org/" target="_blank">Virtual Box</a> that can be <a href="http://www.virtualbox.org/wiki/Downloads" target="_blank">downloaded here</a>. When that’s installed you can follow along here (sorry, I have translated the buttons from my Swedish installation):<br /><ol><li>Make a copy of the existing hard drive (.vhd) to a new folder (VirtualBox/HardDrives for example)  </li><li>Start Virtual Box and chose New (virtual machine)  </li><li>Give the new machine a name and go Next  </li><li>Set the amount of memory you need. And Next  </li><li>Select “Use existing hard drive” and select the .vhd you copied in step 1 (VirtualBox/HardDrives). You’ll need to add it with another dialog:  <ol><li>Click the little green arrow on the folder  </li><li>Chose Add  </li><li>Browse to the file  </li><li>Click OK</li></ol></li><li>Go next and Finish</li></ol>We’re now ready to tweak the VirtualBox-image:<br /><ol><li>Right-click the created VirtualBox environment and select “Settings”  </li><li>Click “System” in the left menu and select the following  <ol><li>Activate IO APIC (needed for <a href="http://en.wikipedia.org/wiki/Symmetric_Multi-Processing" target="_blank">SMP support</a> )  </li><li>Select the number of processors you want the environment to use</li></ol></li><li>Click “Screen” in the left menu  <ol><li>Select the amount of graphic memory you want the environment to have (I have 128 Mb)</li></ol></li><li>Click “Audio” in the left menu  <ol><li>Uncheck Activate audio</li></ol></li><li>Click “Network” in the left menu  <ol><li>Select Bridged network card and you physical systems network card</li></ol></li><li>Done!</li></ol>When the VirtualBox environment starts up for the first time:<br /><ol><li>Be sure to cancel the installation of all windows drivers  </li><li>And install the Guest Additions instead  </li><li>Reboot the virtual machine</li></ol>Right – now we’re closing in on the final part:<br /><ol><li>When the system is booted again, go to %WINDIR%\system32 and make copies (with new name) for these two files:  <ol><li>%WINDIR%\system32\hal.dll to %WINDIR%\system32\hal<strong>sp</strong>.dll  </li><li>%WINDIR%\system32\ntoskrnl.exe to %WINDIR%\system32\ntoskrnl<strong>sp</strong>.exe</li></ol></li><li>Now copy these two files from you Windows SP 3 installation (I386-folder) to %WINDIR%\system32:  <ol><li>HALMACPI.DLL  </li><li>NTKRNLMP.EXE</li></ol></li><li>Now we’re going to add a row in Boot.ini that is our configuration for multiprocessor support. <strong>Be very careful when doing this, errors in boot.ini may cause your system to not boot correctly.</strong>  <ol><li>First show protected operating system files in the Explorer (Tools-&gt;Folder Options-&gt;View)  </li><li>Now remove the write protection from C:\Boot.ini  </li><li>Open C:\Boot.ini and add the following row:<br /><br />multi(0)disk(0)rdisk(0)partition(1)\WINNT="WinXP (native - SMP)" /execute /fastdetect /kernel=NTKRNLMP.EXE /hal=halmacpi.dll<br /> </li><li>Save the file and write protect C:\Boot.ini again.  </li><li>And better put back the hiding of operating system files</li></ol></li><li>Shut down the environment  </li><li>In the VirtualBox console set the number of processors for your system  </li><li>Start the virtual machine again  </li><li>Wait a while for the system to find the drivers for your new configuration.  </li><li>Check the task manager in the virtual image; it should now have the number of processors of your choice</li></ol>Phew – that was a lot of stuff to do, that I mostly didn’t know much about… But my virtual system is now flying! And I also got a lot better screen resolution. Full screen, baby!<br />Thank you Thomas.</div>