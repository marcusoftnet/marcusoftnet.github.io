---
layout: post
title: Nancy.Testing - no hat, no shoes with Simple.Data
date: '2013-02-04T09:00:00.000+01:00'
author: Marcus Hammarberg
tags:
- Nancy
- Tools
- .NET
- C#
modified_time: '2014-06-21T02:09:55.478+02:00'
blogger_id: tag:blogger.com,1999:blog-36533086.post-3442155135108836212
blogger_orig_url: http://www.marcusoft.net/2013/02/NancyTesting4.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><br />This is the fourth (oh my!) post in my series on Nancy.Testing. This time we will leave the Nancy.Testing specific stuff and let our gal meet a friend of mine: <a href="http://simple.data/">Simple.Data</a>(.Testing). By marrying these kids together we will have a really cool full-stack-in-memory-testing-experience (FSIMTE it's gonna be a thing!).<br /><br />I'll supply you with some background to Simple.Data and it's (awesome) testing capabilities, and I probably have to explain the title of this blog post, but then it's just code all the way down.<br /><br />The other posts in the series can be found here:<br /><ol><li><a href="http://www.marcusoft.net/2013/01/NancyTesting1.html" target="_blank">Intro to testing with Nancy</a></li><li><a href="http://www.marcusoft.net/2013/01/NancyTesting2.html" target="_blank">The Configurable bootstrapper</a></li><li><a href="http://www.marcusoft.net/2013/01/NancyTesting3.html" target="_blank">The Browser and Response objects</a>&nbsp;</li><li><a href="http://www.marcusoft.net/2013/02/NancyTesting4.html" target="_blank">Hat and shoeless testing with Simple.Data</a>(this post)</li><li><a href="http://www.marcusoft.net/2013/02/NancyTesting5.html" target="_blank">SpecFlow and Nancy</a></li></ol><div>Let's dive right in a say hello to Simple.Data, if you haven't met him already.&nbsp;</div><div><a name='more'></a><h3 style="text-align: left;">Simple.Data</h3></div><div><a href="http://simple.data/">Simple.Data</a> is a micro-orm. Or as <a href="http://blog.markrendle.net/">Mark Rendle</a> says: It's an ORM without any Objects, there's no Mapping going on and it works against non-Relational databases as well.<br />Simple.Data relies, just as Nancy, a lot on dynamics and allow you to write data access as simple as:<br /><div><script src="https://gist.github.com/4703051.js"></script></div><div>As expected this code opens a connection to the database (as configured in your .config-file, but you could supply a connection string if you wanted). It then issues a SQL-query against the database with a WHERE-part that search for Users with the given Email. Like this:<br /><blockquote class="tr_bq">SELECT * FROM Users WHERE Email = '@p1'</blockquote>Simple right? Oh yeah - it's all in the name. &nbsp;</div><h3>Simple.Data.Testing</h3>Another likeness with Nancy is that Simple.Data have testing as a first class citizen. There's some truly great test-support that you can <a href="http://simplefx.org/simpledata/docs/">read more about in the excellent docs</a>. Here's how some test-code that shows what I mean. </div><div><script src="https://gist.github.com/4703073.js"></script></div><div>The important part here lies in the test code:<br /><br /><ul style="text-align: left;"><li>Line 6-7 sets up an InMemoryAdapter and tells the static Database-object to use that adapter for subsequent calls to Database.Open(). This is a GREAT thing since we now, in our testcode, can change the behavior of the code in the production code.&nbsp;</li><li>Line 10-11 adds a new object into the database. Hihi - you and I know that it's going against the InMemoryAdapter, since that's what we told Database on line 7. This was the first time we called Database.Open() and got a database object using the InMemoryAdapter back.</li><li>Line 14 calls into our &nbsp;method under test. When that method calls Database.Open() (SimpleDataMethodToTest.cs line 3) it ALSO gets the InMemoryAdapter back, since we set it in our testcode.&nbsp;</li><li>The rest of the test method does our asserts.&nbsp;</li></ul><div>With these testing capabilities you have the possibllity to test the data access code. You can setup mock data per test method and doesn't have to create a big testdatabase. This means that we can test the entire stack downwards, to just before we do the jump over the network (maybe) into the database.</div><div>All the way down... or just all the stuff that we have written.&nbsp;</div><div><br /></div><div>For those wondering, yes - you can setup<a href="http://simplefx.org/simpledata/docs/pages/Test/Configuration.htm"> joins, auto incrementing key</a>s etc for your&nbsp;InMemoryAdapter.&nbsp;</div></div><h3 style="text-align: left;">Hat and shoeless</h3><div>As I just said we can now test the stack all the way down to the bottom of our application architecture. And in the rest of the <a href="http://www.marcusoft.net/2013/01/NancyTesting1.html">blog posts of this series</a>, I've talked about how Nancy.Testing allows you to test your whole stack upwards, just before the rendered HTML leaves the web server.<br /><br />You might have heard the term "<a href="http://blog.arhg.net/2009/10/what-is-headless-browser.html">headless browser</a>", that's a browser without GUI. Great for testing, but it still does a network jump and configuring your application to use other objects for testing is <a href="http://blog.stevensanderson.com/2010/03/09/deleporter-cross-process-code-injection-for-aspnet/">demanding to say the least</a>, but it can be done.<br /><br />Combining Nancy and Simple.Data and it's testing capabilities we get something that's really much easier and nicer: let's call it hat and shoeless, shall we?<br />Hatless - in that we can test our whole stack and can just remove the top-layer: the sending of the Response over the network and it's rendering in the browser (that these days could be a lot, I'll give you that :))<br />Shoeless - we Simple.Data testing we can test ALL our code, all the way to and including the actual data access code. Just removing the final, bottom layer (the actual call to the database) is removed.&nbsp;</div><h3 style="text-align: left;">Examples</h3><div>Yeah, I know, I know. Too much talk - too little code. I'll show you 2 examples on how this could work.<br />Here's the first one:<br /><div><script src="https://gist.github.com/4703200.js"></script></div>In this example we first configure the InMemoryAdapter to hold a new FairyTaleFigure "Gollum" and then call into the Module that just returns a string.<br /><br />Let's crank up reality a bit. Let's do a module that uses a Repository and returns a rendered Razor view.<br /><div><script src="https://gist.github.com/4703262.js"></script></div><div>There's nothing new in here, really. But let's go through it real fast:<br /><br /><ul style="text-align: left;"><li>In FullStack_Test.cs (that's the test code in there), we first setup a InMemoryAdapter with Joins and Autoincrementing keys and tell Simple.Data to use that adapter for all subsequent calls to Database.Open().&nbsp;</li><li>On line 35-36 in the same file we configure the <a href="http://www.marcusoft.net/2013/01/NancyTesting2.html">ConfigurableBoostrapper</a>&nbsp;to use our <b>production</b>&nbsp;repository. That's quite ok since we just told Simple.Data to use our "mock" the InMemoryAdapter.&nbsp;</li><li>We then proceed to call into the&nbsp;SimpleDataModuleWithView, via the <a href="http://www.marcusoft.net/2013/01/NancyTesting2.html">Nancy.Testing.Browser</a>&nbsp;object. That's calling the entire stack - but not doing network calls, mind you. We're cutting in just before the web server itself.</li><li>The rest of the code is standard Nancy and Razor code. Mind that the Razor view (the .cshtml-file) needs to be set to <a href="http://www.marcusoft.net/2013/02/NancyViewTesting.html">"Copy if newer"</a> in the Properties window, Copy to output directory in order for Nancy.Testing to be able to render it under test. Read more on this here.</li></ul></div><h3 style="text-align: left;">Summary</h3></div><div>This is so cool! Testing the entire stack - in memory. Superfast, but accessing all the (important) parts. I have to brace myself. But it's really just combining two awesome frameworks that put testability first.<br /><br />As always my code can&nbsp;<a href="https://github.com/marcusoftnet/DiscoveringNancyThroughTests">be found here.</a></div></div>