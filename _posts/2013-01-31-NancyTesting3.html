---
layout: post
title: Nancy.Testing - test-dialogues with Requests and Response
date: '2013-01-31T11:43:00.000+01:00'
author: Marcus Hammarberg
tags:
- Nancy
- Tools
- .NET
- C#
modified_time: '2014-06-21T02:09:55.472+02:00'
blogger_id: tag:blogger.com,1999:blog-36533086.post-3281707504116832093
blogger_orig_url: http://www.marcusoft.net/2013/01/NancyTesting3.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">This is the third post in my series on Nancy.Testing. It will focus a lot of the Browser and the Response object. Together with the Browser (and it's ConfigurableBootstrapper) these objects makes up the entirety of the Nancy.TestingFramework.<br /><a href="http://nancyfx.org/images/logo.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="200" src="http://nancyfx.org/images/logo.png" width="178" /></a><br />Let's do the logo thing again, shall we?<br /><br />The other posts can be found here:<br /><ol><li><a href="http://www.marcusoft.net/2013/01/NancyTesting1.html" target="_blank">Intro to testing with Nancy</a></li><li><a href="http://www.marcusoft.net/2013/01/NancyTesting2.html" target="_blank">The Configurable bootstrapper</a></li><li><a href="http://www.marcusoft.net/2013/01/NancyTesting3.html" target="_blank">The Browser and Response objects</a>&nbsp;(this post)</li><li><a href="http://www.marcusoft.net/2013/02/NancyTesting4.html" target="_blank">Hat and shoeless testing with Simple.Data</a></li><li><a href="http://www.marcusoft.net/2013/02/NancyTesting5.html" target="_blank">SpecFlow and Nancy</a></li></ol><div>By now you're probably just looking for the code so let's dive right in.</div><div><a name='more'></a><h3 style="text-align: left;">Browser</h3></div><div>The Browser object is the one that you use to issue requests to the site you're testing. Most of the Browser configuration is done through the <a href="http://www.marcusoft.net/2013/01/NancyTesting2.html" target="_blank">ConfigurableBootstrapper</a> and let's not go over that again. <br /><br />But the Browser has a couple of other tricks up it's sleeve to. With each method that you can use to issue HTTP Requests (Get, Post, Delete, Put, Options etc) there's configuration to be done to. Here's a real simple example that shows how you can configure your tests to do Https-requests:<br /><div><script src="https://gist.github.com/4658266.js"></script></div>By now you&nbsp;recognize&nbsp;the pattern with configuring your object through a lambda (with =&gt; with.WhatHaveYou). On row 8 and 21 we configure the Get-request to use a Http or an Https-request, that our module under test recognize.<br /><br />There's loads more you can do with each Http-request, the most commonly used I would bet is the Form-posting abilities. Here's one example:<br /><div><script src="https://gist.github.com/4658364.js"></script></div>As you can see from lines 11 and 12 it's quite easy to populate a form to post.<br />This example also showed off model binding in Nancy (line 28). In a internal class, in the test, no references to a web framework. Cool, huh?<br /><br />In much the same manner you can send in values through the&nbsp;query string&nbsp; in cookies or via headers. It's very similar code and I've created a sample here:<br /><div><script src="https://gist.github.com/4658609.js"></script></div>The other ways to send data this way are shown in comments, and you can <a href="https://github.com/marcusoftnet/DiscoveringNancyThroughTests" target="_blank">see my code here</a>.<br /><br />That leaves some special things (expect for AjaxRequest that's really special and I'll leave for you to examine on your own). First out is to create your HTTP Body on your own. Here's an example of doing that:<br /><div><script src="https://gist.github.com/4658667.js"></script></div><br /></div><div style="text-align: left;">This gives you very fine-grained control of the content of the Body, and as you can see from this example (ripped directly from the Nancy.Testing.Test code) we're sending in some JSon in the body on line 11. That's&nbsp;handily&nbsp;taken care of by the handler and bound to our model (line 25).&nbsp;</div><div style="text-align: left;"><br /></div><div style="text-align: left;">You can also send JSon directly in the body. Very&nbsp;conveniently&nbsp;Nancy.Testing also supplies a method for converting a class to Json for you:</div><div><script src="https://gist.github.com/4658828.js"></script></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Let's now go to the other side of the request and take a closer look at the Response-object and see the help that Nancy.Testing gives us there. It's plenty!</div><h3 style="text-align: left;">Response</h3><div>There's loads of interesting stuff on the response object. First you can, of course, access all the properties and assert that expected data was returned. Here's a couple of examples:</div><div><script src="https://gist.github.com/4672839.js"></script></div><div><br />Nothing really strange and suprising there. You can access the properties of the Response just as expected and do your own assertions against them. In these example I'm simply accessing the Headers and Cookies collection. The rest of them behave in the same manner and are:<br /><br /><ul style="text-align: left;"><li>Context - which gives you access to the NancyContext and properties as:&nbsp;</li><ul><li>The Parameters collection</li><li>The CurrentUser</li><li>NegotiationContext</li><li>ModelValidationResult</li><li>ViewBag</li></ul><li>The Body itself which I'll talk about later</li><li>The HTTP status code</li></ul><div><h3 style="text-align: left;">Other Response methods</h3>There's also some special methods that checks for redirects:</div><div><script src="https://gist.github.com/4678677.js"></script></div><br />And also for getting the Body into different formats and even deserilize it into model objects:<br /><div><script src="https://gist.github.com/4678657.js"></script></div></div><h4 style="text-align: left;">Body assertions</h4><div>The Body property is a little gem in itself in that it has all the elements of the <body>-tag as keys (it's a DynamicDictionary). Not only that - you can also search these with normal CSS Selectors. This gives a very nice&nbsp;experience&nbsp;checking for presence of tags, it's content and id etc. I've put together some examples here:</body></div><div><script src="https://gist.github.com/4667201.js"></script></div><div>But hey - there's more: the error messages are to die for. Here's one:</div><blockquote class="tr_bq">"The expected value 'A second message with isd' was not a sub-string of the actual value 'A second message with id'."</blockquote>Tester nirvana - right there! Thank the creators!<br /><div><h3 style="text-align: left;">Summary</h3></div><div>Probably broke my long-blog-post-record there. So I'll end it now.&nbsp;</div><div>A lot of goodies in here for you to deep-dive in. Get my full <a href="https://github.com/marcusoftnet/DiscoveringNancyThroughTests">code here</a>.&nbsp;</div></div>