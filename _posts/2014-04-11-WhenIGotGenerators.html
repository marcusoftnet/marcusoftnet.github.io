---
layout: post
title: 'KoaJs and the "SyntaxError: Unexpected identifier" error - or "that time when
  I understood generators"'
date: '2014-04-11T16:43:00.001+02:00'
author: Marcus Hammarberg
tags:
- Javascript
- Koa
modified_time: '2014-04-11T17:19:56.787+02:00'
blogger_id: tag:blogger.com,1999:blog-36533086.post-4774542661205622224
blogger_orig_url: http://www.marcusoft.net/2014/04/WhenIGotGenerators.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">It was quite sometime since I wrote a blog post with an error message in the title. However I have now got this error so many times, and keep scratching my head every time. Also I think I can explain why it happens.<br /><br /><a name='more'></a><br />Here's an example on how to make this error occur, from the co-monk library <a href="https://github.com/visionmedia/co-monk/pull/4" target="_blank">README (not anymore maybe</a>):<br /><script src="https://gist.github.com/marcusoftnet/10384473.js"></script> <br /><div>Running that code (either with "<span style="font-family: Courier New, Courier, monospace;">node --harmony koaErrorFail.js</span>" or test it with "<span style="font-family: Courier New, Courier, monospace;">mocha --harmony-generators koaErrorFail.js</span>") fail with the error from the title of the blog post:<br /><blockquote class="tr_bq"><div class="p1"><span style="font-family: Courier New, Courier, monospace;">yield users.remove({});</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; ^^^^^</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;">SyntaxError: Unexpected identifier</span></div></blockquote>At this point you start to think that you forgot to run the example with the <a href="http://www.marcusoft.net/2014/03/koaintro.html" target="_blank">"<span style="font-family: Courier New, Courier, monospace;">--harmony</span>" flag</a>. But of course you do that, right?<br />Ah, maybe you are running the <a href="http://www.marcusoft.net/2014/03/koaintro.html" target="_blank">wrong version of Node</a>. Again, no. You're doing it right. Right?<br /><br />However this code is not running within a generator function. And the keyword "<span style="font-family: Courier New, Courier, monospace;">yield</span>" is just allowed within a generator function. In fact, to my understanding, a function is a generator function if it has an asterisk before the name of the function and one or more "<span style="font-family: 'Courier New', Courier, monospace;">yield</span>"s within the function.<br /><br />But we want to say "<span style="font-family: 'Courier New', Courier, monospace;">yield</span>". The&nbsp;<span style="font-family: 'Courier New', Courier, monospace;">yield&nbsp;</span>is good. It's what helps us get non-blocking code. You are basically telling node to do something else while we wait for this operations. Like <a href="http://www.marcusoft.net/2014/03/javascript-callbacks-cant-live-with.html" target="_blank">callbacks</a> but without yuck. <br />But there has to be a generator function around it. And someone to drive the generator for us. I mean that can keep track on where we were when we waited for the next yield.There's has to be <i>someone</i>&nbsp;that takes care of this "<a href="https://www.npmjs.org/package/co" target="_blank">generator async flow control goodness</a>". Someone greater than us. Someone like <a href="https://www.npmjs.org/package/co" target="_blank">co</a>.<br /><br />Co is a neat little library that lets you <a href="https://github.com/visionmedia/co" target="_blank">"write non-blocking code in a nice-ish way"</a>. That's all very complicated if you ask me. But let's show how this co could be used to help us fix the error we ran into before:<script src="https://gist.github.com/marcusoftnet/10464583.js"></script><br />Here we can see that the code, from our failing example is wrapped in a generator function (note the asterisk). This (anonymous) generator function is then passed to the&nbsp;<a href="https://www.npmjs.org/package/co" target="_blank">co</a>-library constructor function. Finally we also invoke the function that co-returns, right away, hence the "<span style="font-family: Courier New, Courier, monospace;">)();"&nbsp;</span><span style="font-family: inherit;">on l<span style="font-family: inherit;">ine 20</span>.&nbsp;</span><br /><h3 style="text-align: left;">Summary and hat tipping</h3></div><div>I would not have grasped this <a href="http://zef.me/6096/callback-free-harmonious-node-js" target="_blank">without this awesome article</a> by <a href="https://twitter.com/zef" target="_blank">Zef</a>. Not only did he write that article but he also helped me when I <a href="https://twitter.com/marcusoftnet/statuses/454620650410237952" target="_blank">reached out to him on Twitter</a>. Thank you mr Zef, my hat is tipped towards you. Loudly (?)&nbsp;</div><div><br /></div><div>Summing up the problem would be something like this:</div><div><ul style="text-align: left;"><li>The "<span style="font-family: Courier New, Courier, monospace;">Unexpected identifier</span>" is not really <span style="font-family: Courier New, Courier, monospace;">users</span> (in my example), but rather that <span style="font-family: Courier New, Courier, monospace;">yield</span> is not valid outside a generator function.&nbsp;</li><li>We can create an anonymous generator function by wrapping the code in "<span style="font-family: Courier New, Courier, monospace;">function *(){ // code }</span>"</li><li>Only problem left, is that we need someone that calls and drives through that function for us, continuing after a&nbsp;<span style="font-family: 'Courier New', Courier, monospace;">yield</span>&nbsp;is reached for example. That could be&nbsp;<a href="https://www.npmjs.org/package/co" target="_blank">co</a>, for example. &nbsp;</li><li>The co constructor takes a generator function as parameter making our entire wrapping for this into "<span style="font-family: Courier New, Courier, monospace;">co(function *(){// code})();</span>"</li></ul><div>I can now find eternal peace. I will probably never be able to explain this again, but then I can come back to this post and "the time I understood generators".&nbsp;</div></div></div>