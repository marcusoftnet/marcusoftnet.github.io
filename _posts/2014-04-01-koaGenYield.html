--- 
layout: post 
title: 'Marcus Node Bit: Let''s talk about yield and generators, shall we?' 
date: '2014-04-01T09:00:00.000+02:00' 
author: Marcus Hammarberg 
tags: 
- NodeJs 
- Javascript 
- Tools 
- Koa 
modified_time: '2014-04-06T14:41:45.558+02:00' 
blogger_id: tag:blogger.com,1999:blog-36533086.post-4757293937630995296 
blogger_orig_url: http://www.marcusoft.net/2014/04/koaGenYield.html 
---

<div dir="ltr" style="text-align: left;" trbidi="on"><a href="http://www.koajs.com/" target="_blank">Koa Js</a> removes need for callbacks but still have uses non-blocking code. How is that possible?
    <br />
    <br />If you read the code of the last blog post you might have reported a bug or two since I was using a strange asterisk at in the getGreeting-function. Is that really valid Javascript?
    <br />
    <br />And when you looked very closely you might be wondering about the "yield" right there in the middle... What kind of witchcraft is this thing anyway?
    <br />
    <br />These questions and more flew threw my head when I first learned about Koa and the concepts its's built upon. In this post I will try to explain that a bit and point you to other places where they explain this much better, if you don't like my tries. This is just how I, a newbie to these concepts, have tried to wrap my head around it. Hey, let's be completely transparent and say that I have to relearn this just about everyday.
    <br />
    <br />It's really not that complicated once you understood it the first time... Just like <a href="http://en.wikipedia.org/wiki/Quantum_mechanics" target="_blank">quantum mechanics</a>...
    <br />
    <br />
    <a name='more'></a>First, let me restate that the things we're diving into now is bleeding edge stuff. It's proposed for the <a href="http://wingolog.org/archives/2013/05/08/generators-in-v8" target="_blank">EcmaScript 6 and is included in Googles V8 Javascript engine</a>. You will need to tweak your environment in order to get this a version of <a href="http://www.nodejs.org/" target="_blank">Node</a> that can execute this. <a href="http://www.marcusoft.net/2014/03/koaintro.html" target="_blank">Read this for instructions</a>.
    <br />
    <br />I have learned LOADS from this <a href="http://tobyho.com/2013/06/16/what-are-generators/" target="_blank">awesome article</a> by <a href="https://twitter.com/airportyh" target="_blank">Toby Ho</a>. Here I'm just writing down how I understood it. All credit for any good stuff here goes to Toby. Any crap is probably from me.
    <br />
    <h3 style="text-align: left;">What is yield?</h3>Now, on to the war... The first concept that tripped me a bit was <span style="font-family: Courier New, Courier, monospace;">yield</span>. &nbsp;I have not thought much about nor used <span style="font-family: Courier New, Courier, monospace;">yield</span> in my&nbsp;mother-tongue, C#, that have had them for quite some time. Quite simple it can be described with the following code:
    <br />
    <script src="https://gist.github.com/marcusoftnet/9831877.js"></script> This will just continue looping forever, so it's not very useful that way. But look at line 3, we're not actually <i>returning</i>&nbsp;anything. Instead we are <i>yielding</i>&nbsp;the result. I can't relate to that expression. It simply doesn't mean(t) anything to mean. My mind just goes ".........".
    <br />
    <br />But when I <a href="http://tobyho.com/2013/06/16/what-are-generators/" target="_blank">understood that</a>:
    <br />
    <blockquote class="tr_bq">when the code encounters a yield statement, it suspends execution indefinitely, and doesn't start again until you tell it to</blockquote>I was intrigued to say the least. Could this be used instead of <a href="http://www.marcusoft.net/2014/03/javascript-callbacks-cant-live-with.html" target="_blank">callbacks</a>&nbsp;when doing non-blocking, asynchronous code?&nbsp;But how? Let's press on and see if that is the case.
    <br />
    <h4 style="text-align: left;">Aha, but what is generators then?</h4>Ok, but how can I use this then? Or in other words; how can I call this loop? Let's wrap that loop in a function. Like this:
    <br />
    <script src="https://gist.github.com/marcusoftnet/9831956.js"></script>Please not the little asterisk at the function. This is how Javascript denotes <i>generator functions</i>&nbsp;and I'll come back to that later. A function becomes a generator function when you have at least one yield in it. And you need to add the asterisk.
    <br />
    <br />"Well, that pretty and everything, but how do we use that function then?" you ask.
    <br />We have to create a instance of the generator function and then get the <i>next</i> element in the sequence by calling ... <span style="font-family: Courier New, Courier, monospace;">next()</span>. Like this:
    <br />
    <script src="https://gist.github.com/marcusoftnet/9832278.js"></script>
    <br />That was the quote about mean when it said: "... until you tell it to". The code will halt at the yield until we tell it to continue, and we tell it by calling <span style="font-family: Courier New, Courier, monospace;">.next()</span> on the function instance.
    <br />To run this, remember that you have to call Node with the "--harmony" flag, as described in <a href="http://www.marcusoft.net/2014/03/koaintro.html" target="_blank">my earlier post</a>. This is the command I used:
    <br />
    <blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;">node --harmony callingGenerator.js</span></blockquote>Two things worth noting here. First, nothing happens until you call&nbsp;<span style="font-family: 'Courier New', Courier, monospace;">.next()</span>.The loop in the generator is doing&nbsp;nothing in the meantime. Like a block of code that waits for an asynchronous callback ^^.
    <br />Also it's worth noting that what we get back is a object with two properties; <i>value</i> and <i>done</i> (true/false). The <span style="font-family: Courier New, Courier, monospace;">done</span> parameter equals true when the sequence is over, as shown in this example:
    <script src="https://gist.github.com/marcusoftnet/9832352.js"></script>
    <br />If you run that you will get <span style="font-family: Courier New, Courier, monospace;">done === true</span> for the fourth call to <span style="font-family: Courier New, Courier, monospace;">.next()</span> (with the value === undefined). The fifth call throws an exception ("Generator has already finished").
    <br />
    <br />Tying back to the heading of this section: a generator is simply a function that represents a sequence of values. We saw examples of ending and non ending sequences above. You can use the generator by creating a generator object and call <span style="font-family: Courier New, Courier, monospace;">next()</span> to get the next value. &nbsp;It's like <i>iterating </i>through the return values of the function.
    <br />
    <h3 style="text-align: left;">What use is this? And what's all this talk about Koa?</h3>This is a mind-twister and interesting and all that... but use can we have from this? Well, yield and generators is in fact the helping hand that will draw us up from callback hell and put our feet back on solid, well-tramped ground.
    <br />
    <br />Did you notice the little passage about the asynchronous wait above? The thing is, when yield is called the code is waiting for you to call .next() to continue. For as long as that take. In the meantime Node can do something else that is more important than waiting. You recognize this? (Saved the fact that I wrote it above ^^). This is what <a href="http://www.marcusoft.net/2014/03/javascript-callbacks-cant-live-with.html" target="_blank">callbacks gives us</a>. Non blocking code. Sadly to the cost of nesting and tightly coupled code, where you have to pass parameters that the inner most code need.
    <br />
    <br />Let's take a look at an example on how&nbsp;<a href="http://www.koajs.com/" target="_blank">Koa Js</a>&nbsp;uses this. This example is doing some very simple logging and really made the usefulness of generators stand out for me. Start this simple site up and then access it from the terminal with "<span style="font-family: Courier New, Courier, monospace;">curl http://localhost:3000 -v</span>" so that you can see the headers returned, and there you see the&nbsp;X-Response-Time reported. As well at the console.
    <br />
    <script src="https://gist.github.com/marcusoftnet/9849721.js"></script>
    <br />Let's see if we can break it down a bit. app.use() is how Koa defines middleware. In this case the middleware is just two simple generator functions. When the request comes in the following happens:
    <br />
    <ul style="text-align: left;">
        <li>First, since it's defined first, the&nbsp;x-response-time generator function is called. It get's hold of the current date and time and then <i>yields </i>the passed in next variable. This is a Koa variable that indicates the next middleware in line</li>
        <ul>
            <li>So, we end up in the logger middleware. This generator function does the same thing. Get hold of "now" and yields out the next middleware</li>
            <ul>
                <li>There's no more middleware defined so we are taken to the response (for any route in this case) that always sets the body to "Hello world!"</li>
            </ul>
            <li>When the response is created the execution is turned back to the logging middleware that calculate the response time for this request and blurts it out on the console</li>
        </ul>
        <li>The&nbsp;x-response-time middleware does the same thing, but saves the result into the header of the response.&nbsp;</li>
    </ul>
    <div>If you want to you could read the middleware code like this: "Get the start time. Do whatever else you need to do. When that is done subtract the current time from the start and save the result in the header". In a easy to read, sequential fashion. No callbacks and long indention chains.&nbsp;</div>
    <div>
        <br />
    </div>
    <div>I like that. A lot. It's simple, short and easy to read and understand. All the hard stuff about generators... Well we don't have to think so much about that. Yield means: "do everything else you need to do at this point".&nbsp;</div>
    <div>Here's another example where we store the data from a post into a Mongo-database using <a href="http://www.marcusoft.net/2014/02/mnb-monk.html" target="_blank">Monk</a>&nbsp;via the coroutine library <a href="https://www.npmjs.org/package/co-monk" target="_blank">Co-Monk</a>&nbsp;(which is the simplest way to access MongoDb with generators right now):</div>
    <script src="https://gist.github.com/marcusoftnet/9853669.js"></script>
    <br />Again, using curl (why not?) we can now add a couple of users with the following commands:
    <br />
    <script src="https://gist.github.com/marcusoftnet/9853690.js"></script>And then see the result with this:
    <br />
    <blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;">curl http://localhost:3000/user -v</span></blockquote>Pretty short and sweet for adding user, if you ask me. More interesting, let's go through the code.
    <br />
    <ul style="text-align: left;">
        <li>First there's a couple of requires that bring in the things we are going to use. The "lego" pieces in Koa is pretty small so there's usually at least a couple of them.</li>
        <li>Line 8-11 sees us set up <a href="http://www.marcusoft.net/2014/02/mnb-monk.html" target="_blank">Monk</a>, and use it with "mongodb generator goodness for co" via <a href="https://www.npmjs.org/package/co-monk" target="_blank">co-monk</a>. Man I love Monk. It's really sweet!</li>
        <li>On line 14 and 15 we set up our routes and simple direct them to a couple of generator functions that is found below. This is how Koa calls out to other things.</li>
        <li>In the create generator function (note the asterisk) we have two yields</li>
        <ul>
            <li>first (line 21) we parse the body (with co-body) and if that should take time, for big file for example, we yield the response. Koa can let other execute in the meantime. Just like for a callback. But without the callback.&nbsp;</li>
            <li>secondly, on line 27, we store the object in mongo. And better yield there too since that might take time, or at least is IO.&nbsp;</li>
            <li>Did you see that try...catch. It's back baby! Error handling that feels reasonable. Structured exception handling I think it's called. The alternative is in other words ... &nbsp;:)</li>
        </ul>
        <li>In the list generator we just yield the result from our, very simple, Mongo query. See line 38.&nbsp;</li>
        <li>Line 43 fires the whole thing up.&nbsp;</li>
    </ul>
    <h3 style="text-align: left;">Conclusion</h3>
    <div>Around this point when I'm using Koa I always thing to myself... So what's the deal with generators, what did that really give me? Its actually pretty easy to forget and to me that is a good thing. Because I just write the code like I would "normally" without callbacks. Feels much more natural to me. And when I'm doing IO or Networking I remember to yield to let Koa do other things.&nbsp;</div>
    <div>
        <br />
    </div>
    <div>I have had GREAT use of a couple of articles to explain this to me.&nbsp;</div>
    <div>
        <ul style="text-align: left;">
            <li><a href="http://tobyho.com/2013/06/16/what-are-generators/" target="_blank">What Is This Thing Called Generators?</a>&nbsp;is <b>awesome</b>&nbsp;and a must read.</li>
            <li>Two articles from Mozilla on the topic was interesting; <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators" target="_blank">the first</a>&nbsp;was obsolete but had great examples. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*" target="_blank">The second</a> is up to date but very short and ... left me wanting more.&nbsp;</li>
            <li><a href="http://www.koajs.com/" target="_blank">KoaJs</a> own site has a couple of good examples</li>
        </ul>
    </div>I want to thank all those resources and humbly point to them for more, better and in-depth information. This is just my understanding, written for me to remember. Because I have now forgot how this worked again, and need to start over :)
    <br />
    <br />My code is in those gists listed above or <a href="https://github.com/marcusoftnet/KoaBlogPosts/tree/master/KoaFirstStumblingSteps" target="_blank">here in a repo</a>.
    <br />
    <br />I like Koa Js. I've written a couple of post about it. Here they will be when they are published:
    <br />
    <ul>
        <li><a href="http://www.marcusoft.net/2014/03/koaintro.html" target="_blank">Let's talk about Koa for a while, shall we?</a></li>
        <li>Let's talk about yield and generators, shall we? (this post)</li>
        <li><a href="http://www.marcusoft.net/2014/04/koaExamples.html" target="_blank">Marcus Node Bits: Let's flex Koa Js, shall we?</a></li>
    </ul>
</div>