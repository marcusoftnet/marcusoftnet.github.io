---
layout: post
title: NUnit testing asynchronous events
date: '2006-10-25T12:14:00.000+02:00'
author: Marcus Hammarberg
tags:
- Tools
- .NET
modified_time: '2010-12-14T16:22:38.409+01:00'
blogger_id: tag:blogger.com,1999:blog-36533086.post-2786272295120950128
blogger_orig_url: http://www.marcusoft.net/2006/10/nunit-testing-asynchronous-events.html
---

In my current project we are using a some asynchronous <span class="blsp-spelling-error" id="SPELLING_ERROR_0" onclick="BLOG_clickHandler(this)">webservice</span> method calls. The actual call are in turn encapsulated in a layer that is used by the GUI, the "<span class="blsp-spelling-error" id="SPELLING_ERROR_1" onclick="BLOG_clickHandler(this)">ClientCommand</span>"-layer.<br /><br />However when writing tests for these method we ran into <span class="blsp-spelling-corrected" id="SPELLING_ERROR_2">trouble</span>.... First the <span class="blsp-spelling-error" id="SPELLING_ERROR_3" onclick="BLOG_clickHandler(this)">NUnit</span>-framework is not very good at handling events at all, but by using this excellent <a href="http://www.peterprovost.org/archive/2005/05/29/3497.aspx">article </a>by Peter Provost i got a nice, compact way of doing the tests.<br /><br />Then it was the whole asynchronous thing, which really was hard to get by. The solution given above worked out fine as long as not any assertions went threw exceptions - but what is the use of that?<br /><br />So the simple solution to the problem was to simply wait for the event to fire and be handled. This was solved by setting a <span class="blsp-spelling-error" id="SPELLING_ERROR_4" onclick="BLOG_clickHandler(this)">bool</span> variable (<span class="blsp-spelling-error" id="SPELLING_ERROR_5" onclick="BLOG_clickHandler(this)">bEventHandled</span>) and not continue with the assertions until that <span class="blsp-spelling-error" id="SPELLING_ERROR_6" onclick="BLOG_clickHandler(this)">bool</span> was true.<br /><br />The event handling delegate sets the method variables to the return values from the event and finally switch the <span class="blsp-spelling-error" id="SPELLING_ERROR_7" onclick="BLOG_clickHandler(this)">EventHandled</span>-<span class="blsp-spelling-error" id="SPELLING_ERROR_8" onclick="BLOG_clickHandler(this)">bool</span> to true so that the assertions can be run.<br /><br />Here's the code for a example:<code><br />[Test(Description = "Demo <span class="blsp-spelling-error" id="SPELLING_ERROR_9" onclick="BLOG_clickHandler(this)">Async</span> call")]<br />public void <span class="blsp-spelling-error" id="SPELLING_ERROR_10" onclick="BLOG_clickHandler(this)">DemoAsyncTest</span>()<br />{<br />// Create the variables to hold result<br /><span class="blsp-spelling-error" id="SPELLING_ERROR_11" onclick="BLOG_clickHandler(this)">EpasAsyncUserStateArgs</span> <span class="blsp-spelling-error" id="SPELLING_ERROR_12" onclick="BLOG_clickHandler(this)">argsActual</span> = null;<br /><span class="blsp-spelling-error" id="SPELLING_ERROR_13" onclick="BLOG_clickHandler(this)">DataSet</span> <span class="blsp-spelling-error" id="SPELLING_ERROR_14" onclick="BLOG_clickHandler(this)">dsActual</span> = null;<br /><span class="blsp-spelling-error" id="SPELLING_ERROR_15" onclick="BLOG_clickHandler(this)">bool</span> <span class="blsp-spelling-error" id="SPELLING_ERROR_16" onclick="BLOG_clickHandler(this)">bEventHandled</span> = false;<br /><br />// Create the object to test<br /><span class="blsp-spelling-error" id="SPELLING_ERROR_17" onclick="BLOG_clickHandler(this)">ClaimsReportClientCommand</span> c = new <span class="blsp-spelling-error" id="SPELLING_ERROR_18" onclick="BLOG_clickHandler(this)">ClaimsReportClientCommand</span>();<br /><br />// Subscribe to the event with a delegate<br />c.<span class="blsp-spelling-error" id="SPELLING_ERROR_19" onclick="BLOG_clickHandler(this)">LoadClaimInfoCompleted</span> += delegate<br />(<span class="blsp-spelling-error" id="SPELLING_ERROR_20" onclick="BLOG_clickHandler(this)">EpasAsyncUserStateArgs</span> <span class="blsp-spelling-error" id="SPELLING_ERROR_21" onclick="BLOG_clickHandler(this)">args</span>, <span class="blsp-spelling-error" id="SPELLING_ERROR_22" onclick="BLOG_clickHandler(this)">DataSet</span> <span class="blsp-spelling-error" id="SPELLING_ERROR_23" onclick="BLOG_clickHandler(this)">dsResult</span>)<br />{<br />// Set the method variable</code><br /><code>// This can be done because of the a</code><code><span class="blsp-spelling-error" id="SPELLING_ERROR_24" onclick="BLOG_clickHandler(this)">nonymous</span> delegate<br /><span class="blsp-spelling-error" id="SPELLING_ERROR_25" onclick="BLOG_clickHandler(this)">argsActual</span> = <span class="blsp-spelling-error" id="SPELLING_ERROR_26" onclick="BLOG_clickHandler(this)">args</span>;<br /><span class="blsp-spelling-error" id="SPELLING_ERROR_27" onclick="BLOG_clickHandler(this)">dsActual</span> = <span class="blsp-spelling-error" id="SPELLING_ERROR_28" onclick="BLOG_clickHandler(this)">dsResult</span>;<br /><br />// set the event handled<br /><span class="blsp-spelling-error" id="SPELLING_ERROR_29" onclick="BLOG_clickHandler(this)">bEventHandled</span> = true;<br />};<br /><br />// Do call that generates the event<br />c.<span class="blsp-spelling-error" id="SPELLING_ERROR_30" onclick="BLOG_clickHandler(this)">LoadClaimInfoById</span>(<span class="blsp-spelling-error" id="SPELLING_ERROR_31" onclick="BLOG_clickHandler(this)">CLAIMREPORT</span>_ID_<span class="blsp-spelling-error" id="SPELLING_ERROR_32" onclick="BLOG_clickHandler(this)">EXSTING</span>, "<span class="blsp-spelling-error" id="SPELLING_ERROR_33" onclick="BLOG_clickHandler(this)">se</span>");<br /><br />// Wait until the event is handled<br />while (!<span class="blsp-spelling-error" id="SPELLING_ERROR_34" onclick="BLOG_clickHandler(this)">bEventHandled</span>)<br />{<br />System.Threading.Thread.Sleep(50);<br />}<br /><br />// Result <span class="blsp-spelling-error" id="SPELLING_ERROR_35" onclick="BLOG_clickHandler(this)">recived</span> - do assertions (whatever...)<br />Assert.<span class="blsp-spelling-error" id="SPELLING_ERROR_36" onclick="BLOG_clickHandler(this)">IsNotNull</span>(<span class="blsp-spelling-error" id="SPELLING_ERROR_37" onclick="BLOG_clickHandler(this)">argsActual</span>);<br />Assert.<span class="blsp-spelling-error" id="SPELLING_ERROR_38" onclick="BLOG_clickHandler(this)">IsNotNull</span>(<span class="blsp-spelling-error" id="SPELLING_ERROR_39" onclick="BLOG_clickHandler(this)">dsActual</span>);<br />}<br /><br /></code>So, as you can see, most of it is a complete rip of from Peters article. The delegate-stuff is the key for this to work. If the <span class="blsp-spelling-error" id="SPELLING_ERROR_40" onclick="BLOG_clickHandler(this)">eventhandler</span> is a standard <span class="blsp-spelling-error" id="SPELLING_ERROR_41" onclick="BLOG_clickHandler(this)">eventhandler</span> it cannot set the variables in the method for the later assertions. Also the whole <span class="blsp-spelling-error" id="SPELLING_ERROR_42" onclick="BLOG_clickHandler(this)">testcode</span> is in one method which also is good.<br /><br />I realise that it probably could be another, better and slicker way of testing asynchronous <span class="blsp-spelling-error" id="SPELLING_ERROR_43" onclick="BLOG_clickHandler(this)">webservice</span> methods, but I haven't found it. After quite a while of googling i must add. If you know one, please let me know too :-)